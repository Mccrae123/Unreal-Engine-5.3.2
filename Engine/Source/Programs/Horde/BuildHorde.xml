<?xml version='1.0' ?>
<BuildGraph xmlns="http://www.epicgames.com/BuildGraph" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.epicgames.com/BuildGraph ../../../Engine/Build/Graph/Schema.xsd" >

	<Option Name="PreflightChange" DefaultValue="" Description="Preflight changelist number"/>
	<Option Name="Configuration" DefaultValue="release" Description="Configuration to build"/>
	
	<Property Name="EngineDir" Value="$(RootDir)/Engine"/>

	<Property Name="Version" Value="$(EngineMajorVersion).$(EngineMinorVersion).$(EnginePatchVersion)"/>
	<Property Name="InformationalVersion" Value="$(Version)-$(Change)"/>
	<Property Name="InformationalVersion" Value="$(InformationalVersion)-PF-$(PreflightChange)" If="'$(PreflightChange)' != ''"/>
	<Property Name="VersionArguments" Value="/p:Version=$(Version).0 /p:InformationalVersion=$(InformationalVersion)"/>

	<!--- SERVER --->

	<Agent Name="HordeServer" Type="Linux;Win64_Docker">
		<Property Name="StagingDir" Value="$(RootDir)/Engine/Saved/Horde.Server"/>
		
		<Node Name="Build HordeServer">
			<!-- Tag all the files that need to be staged to build -->
			<Property Name="StagePaths">
				Engine/Binaries/DotNET/EpicGames.Perforce.Native/...
				Engine/Source/Programs/Shared/...
				Engine/Source/Programs/Horde/...
				Engine/Source/Programs/AutomationTool/AutomationUtils/Matchers/...
				Engine/Source/Programs/UnrealBuildTool/Matchers/...
			</Property>
			<Tag Files="$(StagePaths)" Except=".../.vs/...;.../.git/...;.../bin/...;.../obj/..." With="#InputFiles"/>

			<!-- Build the Docker image and publish it -->
			<Docker-Build BaseDir="Engine" Files="#InputFiles" Tag="hordeserver-public" DockerFile="Engine/Source/Programs/Horde/Horde.Server/Dockerfile" Arguments="--build-arg msbuild_args=&quot;$(VersionArguments)&quot;"/>
		</Node>
	</Agent>
	
	<!--- INSTALLER --->
	
	<Agent Name="HordeInstaller" Type="Win64_Docker">
		<Property Name="StagingDir" Value="$(RootDir)/Staging"/>

		<Node Name="Stage HordeInstaller">
			<Delete Files="$(StagingDir)/..."/>
			<DotNet Arguments="publish &quot;$(RootDir)/Engine/Source/Programs/Horde/Horde.Server/Horde.Server.csproj&quot; --output &quot;$(StagingDir)/Server&quot; --runtime win-x64 $(VersionArguments)"/>
			<DotNet Arguments="publish &quot;$(RootDir)/Engine/Source/Programs/Horde/Horde.Agent/Horde.Agent.csproj&quot; --output &quot;$(StagingDir)/Agent&quot; $(VersionArguments)"/>

			<!-- Do not include development defaults which created a ue5 project and stream -->
			<Delete Files="$(StagingDir)/Server/Defaults/..."/>

			<!-- Create build settings -->
			<WriteTextFile File="$(StagingDir)/Server/appsettings.Build.json" Text="{ &quot;Horde&quot;: { &quot;SingleInstance&quot;: true } }"/>
	
			<Spawn Exe="cmd.exe" Arguments="/C yarn install" WorkingDir="$(RootDir)/Engine/Source/Programs/Horde/HordeDashboard"/>
			<Spawn Exe="cmd.exe" Arguments="/C yarn run build" WorkingDir="$(RootDir)/Engine/Source/Programs/Horde/HordeDashboard"/>
	
			<Copy From="$(RootDir)/Engine/Source/Programs/Horde/HordeDashboard/build/..." To="$(StagingDir)/Server/DashboardApp/..."/>
		</Node>

		<Property Name="WixDir" Value="$(RootDir)/Engine/Source/ThirdParty/WiX/3.8"/>
		<Property Name="SourceDir" Value="$(RootDir)/Engine/Source/Programs/Horde/Installer"/>
		<Property Name="ObjDir" Value="obj/Debug"/>
		<Property Name="BinDir" Value="bin/Debug"/>
		
		<Node Name="Build HordeInstaller" Requires="Stage HordeInstaller">
			<Property Name="CommonArgs" Value="-dConfiguration=Debug -dPlatform=x64 -arch x64"/>

			<Delete Files="$(StagingDir)/Server-Bulk/..."/>
			<Tag Files="$(StagingDir)/Server/..." Except="HordeServer.exe" With="#ServerFiles"/>
			<Copy Files="#ServerFiles" From="$(StagingDir)/Server" To="$(StagingDir)/Server-Bulk/Server"/>
			<Spawn Exe="$(WixDir)/heat.exe" Arguments="dir &quot;$(StagingDir)/Server-Bulk&quot; -cg HordeServerFiles -scom -sreg -gg -dr InstallDir -srd -var var.SourceDir -out &quot;$(SourceDir)/HordeServerFiles.wxs&quot;"/>
			<Spawn Exe="$(WixDir)/candle.exe" Arguments="$(CommonArgs) HordeServerFiles.wxs -dSourceDir=&quot;$(StagingDir)&quot; -out $(ObjDir)/HordeServerFiles.wixobj" WorkingDir="$(SourceDir)"/>

			<Spawn Exe="$(WixDir)/candle.exe" Arguments="$(CommonArgs) Installer.wxs -dStagingDir=&quot;$(StagingDir)&quot; -out $(ObjDir)/Installer.wixobj" WorkingDir="$(SourceDir)"/>
			<Spawn Exe="$(WixDir)/light.exe" Arguments="-out $(BinDir)/Horde.msi -sw1076 -pdbout $(BinDir)/Horde.pdb $(ObjDir)/Installer.wixobj $(ObjDir)/HordeServerFiles.wixobj" WorkingDir="$(SourceDir)"/>
		</Node>
		
	</Agent>

</BuildGraph>
